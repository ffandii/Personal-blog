---
layout: post
title: "算法和流程控制"
description: "代码的整体结构是影响运行速度的主要因素之一。代码数量少一定运行快，代码数量多确不意味着运行速度一定慢。影响性能的最直接因素是代码的组织结构，以及具体问题的解决办法。"
category: algorithm
tags: [算法,性能优化,读书笔记]
---
{% include JB/setup %}
<div class="p-section">
	<h3>循环</h3>
	<p>对大多数编程语言而言，代码执行时间大部分消耗在循环中。循环处理一系列值是最常见的编程模式之一，因此也是提升性能必须关注的要点之一。理解javascript中循环对性能的影响至关重要，死循环或长时间运行的循环会严重影响整体用户体验。javascript中有四种类型的循环。第一种是标准<code>for</code>循环，与其他类C语言的语法相同，<code>for</code>循环清晰明确的语法风格被开发者们所喜爱；第二种为<code>while</code>循环，它是最简单的前测循环，由一个前测条件和一个循环体构成；第三种循环类型为do-while循环，它是javascript中唯一一种后测循环；最后一种循环类型为for-in循环，它有个非常特殊的用途，就是可以枚举任何对象的属性名。</p>
	<p>不断引发循环性能争论的源头是循环类型的选择。在javascript提供的四种循环类型中，只有for-in循环比其他几种明显要慢。由于每次迭代操作会同时搜索实例或原型属性，for-in循环的每次迭代都会产生额外的开销，因此要比其他循环类型要慢。对比相同迭代次数的循环，for-in循环最终只有其他类型速度的1/7。因此，除非你需要迭代一个属性数量未知的对象，否则应尽量避免使用for-in循环。除for-in循环外，其他循环类型的性能都差不多，深究哪种循环没有意义，循环类型的选择更应基于需求而不是性能。如果循环类型与性能无关，那么该如何选择呢？其实只有两个可选因素：（1）每次迭代处理的事物（2）迭代的次数。通过减少这两个中的任何一个或全部，都能对循环的整体性能产生积极影响。</p>
	<p>很明显，如果一次循环迭代要花很长时间去执行，那么多次循环就需要花费更长的时间。一个提升循环整体速度的好办法是限制循环中耗时操作的数量。即使是在循环体中最快的代码，累计迭代上千次也会变慢下来，此外循环体运行时也会带来小性能开销，不仅仅是增加了总体运行时间。减少迭代次数能获得更加显著的性能提升。最广为人知的一种限制循环迭代次数的模式被称为“达夫设备”。"Duff's Device"是一个循环体展开技术，它使得一次迭代中实际上执行了多次跌打的操作。一个典型实现如下：</p>
<pre><code class="javascript">//credit: Jeff Greenberg
var iterations=Math.floor(items/8),
startAt=items%8,
i=0;

do { 
   switch(startAt){
      case 0: process(items[i++]);
	  case 7: process(items[i++]);
	  case 6: process(items[i++]);
	  case 5: process(items[i++]);
	  case 4: process(items[i++]);
	  case 3: process(items[i++]);
	  case 2: process(items[i++]);
	  case 1: process(items[i++]);
   }
   startAt=0;
}while(--iterations)
</code></pre>	
	<p>Duff's Device背后的基本理念是：每次循环最多调用8次<code>process()</code>。循环的迭代次数为总数除以8，变量startAt用来存放余数是否使用Duff's Device，很大程度上依赖于迭代次数。如果循环迭代次数小于1000，你很有可能看到它与常规循环结构相比只有微不足道的性能提升。如果迭代次数超过1000，那么它的执行效率将会得到明显的提升，例如在500000次迭代中，其运行时间比常规少70%。</p>
</div>

<div class="p-section">
	<h3>条件语句</h3>
	<p>与循环的原理类似，条件表达式决定了javascript程序的流句。其他语言对应该使用if-else语句还是switch语句的传统观点同样适用于javascript。由于不同的浏览器针对流程控制进行了不同的优化，因此使用哪种技术更没有定论。使用if-else语句还是switch，最流行的方法是基于测试条件的数量来判断：条件数量越大，越倾向于使用switch而不是if-else。这通常归结为代码的可读性，通常，当判断多于两个离散值时，switch语句是更好的判断。</p>
	<p>优化if-else的目标是：最小化到达正确分支前所需判断的条件数量，最简单的优化方法是确保最可能出现的条件放在首位，if-else中的条件语句应该总是按照从最大概率到最小概率的顺序排列，以确保运行速度最快。另一种减少条件判断次数的方法是把if-else组织成一系列嵌套的if-else语句，使用单个庞大的if-else会运行很慢，因为每个条件都需要判断。</p>
	
</div>